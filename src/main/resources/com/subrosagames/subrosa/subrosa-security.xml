<?xml version="1.0" encoding="UTF-8"?>
<beans:beans xmlns="http://www.springframework.org/schema/security"
             xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
             xmlns:beans="http://www.springframework.org/schema/beans"
             xsi:schemaLocation="
                        http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-4.0.xsd
                        http://www.springframework.org/schema/security http://www.springframework.org/schema/security/spring-security-3.2.xsd
                        ">

  <global-method-security pre-post-annotations="enabled">
    <expression-handler ref="expressionHandler"/>
  </global-method-security>
  <beans:bean id="expressionHandler"
        class="org.springframework.security.access.expression.method.DefaultMethodSecurityExpressionHandler">
    <beans:property name="permissionEvaluator">
      <beans:bean class="com.subrosagames.subrosa.security.SubrosaAclPermissionEvaluator"/>
    </beans:property>
  </beans:bean>

  <http auto-config="false" use-expressions="true" entry-point-ref="http403ForbiddenEntryPoint">
    <custom-filter ref="usernamePasswordAuthenticationFilter" after="EXCEPTION_TRANSLATION_FILTER"/>
    <custom-filter ref="deviceSessionAuthenticationFilter" position="PRE_AUTH_FILTER"/>
    <intercept-url pattern="/v1/session" access="isAnonymous()"/>
    <intercept-url pattern="/v1/game/**" access="permitAll"/>
    <intercept-url pattern="/v1/test/**" access="isAuthenticated()"/>
    <logout logout-url="/v1/logout" success-handler-ref="http200LogoutSuccessHandler"/>
  </http>

  <beans:bean id="http200LogoutSuccessHandler" class="com.subrosagames.subrosa.security.Http200LogoutSuccessHandler"/>

  <beans:bean id="http403ForbiddenEntryPoint"
              class="org.springframework.security.web.authentication.Http403ForbiddenEntryPoint"/>
  <beans:bean id="usernamePasswordAuthenticationFilter"
              class="com.subrosagames.subrosa.security.JsonUsernamePasswordAuthenticationFilter">
    <beans:property name="authenticationSuccessHandler" ref="jsonTokenAuthenticationSuccessHandler"/>
    <beans:property name="authenticationFailureHandler" ref="jsonResponseAuthenticationFailureHandler"/>
    <beans:property name="filterProcessesUrl" value="/v1/session"/>
    <beans:property name="authenticationManager" ref="authenticationManager"/>
  </beans:bean>

  <beans:bean id="deviceSessionAuthenticationFilter"
              class="org.springframework.security.web.authentication.preauth.RequestHeaderAuthenticationFilter">
    <beans:property name="exceptionIfHeaderMissing" value="false"/>
    <beans:property name="continueFilterChainOnUnsuccessfulAuthentication" value="true"/>
    <beans:property name="principalRequestHeader" value="X-SUBROSA-AUTH"/>
    <beans:property name="authenticationManager" ref="authenticationManager"/>
  </beans:bean>

  <beans:bean id="jsonTokenAuthenticationSuccessHandler"
              class="com.subrosagames.subrosa.security.JsonResponseAuthenticationSuccessHandler"/>
  <beans:bean id="jsonResponseAuthenticationFailureHandler"
              class="com.subrosagames.subrosa.security.JsonResponseAuthenticationFailureHandler"/>

  <beans:bean id="preAuthAuthenticationProvider"
              class="org.springframework.security.web.authentication.preauth.PreAuthenticatedAuthenticationProvider">
    <beans:property name="throwExceptionWhenTokenRejected" value="true"/>
    <beans:property name="preAuthenticatedUserDetailsService" ref="preAuthenticatedUserDetailsService"/>
  </beans:bean>
  <beans:bean id="preAuthenticatedUserDetailsService"
              class="com.subrosagames.subrosa.security.DeviceSessionUserDetailsService"/>

  <beans:bean id="userDetailsService" class="com.subrosagames.subrosa.security.SubrosaUserDetailsService"/>
  <beans:bean id="passwordEncoder" class="com.subrosagames.subrosa.security.SubrosaSha512PasswordEncoder"/>
  <beans:bean id="saltSource" class="org.springframework.security.authentication.dao.ReflectionSaltSource">
    <beans:property name="userPropertyToUse" value="salt"/>
  </beans:bean>

  <authentication-manager alias="authenticationManager">
    <authentication-provider ref="preAuthAuthenticationProvider"/>
    <authentication-provider user-service-ref="userDetailsService">
      <password-encoder ref="passwordEncoder">
        <salt-source ref="saltSource"/>
      </password-encoder>
    </authentication-provider>
  </authentication-manager>


</beans:beans>
