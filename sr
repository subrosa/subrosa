#!/bin/bash

DIR="$( cd "$( dirname "$0" )" && pwd )"
JAR=${DIR}/build/libs/subrosa-1.0.0-SNAPSHOT.jar

init_config() {
    echo "Initializing environment..."
    echo -n "LDAP Username: "
    read ldapUser
    echo -n "LDAP Password: "
    read -s ldapPass
    echo

    cat << FILE > ${DIR}/gradle.properties
nexusUsername=${ldapUser}
nexusPassword=${ldapPass}
FILE
}

run() {
    vagrant up
    vagrant ssh -c "cd /vagrant; fig restart"
    ./gradlew flywayMigrate run
}

case "$1" in
    init)
        [ ! -f ${DIR}/gradle.properties ] && init_config
        vagrant up
        vagrant ssh -c "cd /vagrant; fig pull --allow-insecure-ssl; fig up -d"
        ./gradlew flywayMigrate run
    ;;
    run)
        run
    ;;
    ssh)
        vagrant up
        vagrant ssh
    ;;
    *)
        vagrant up
        vagrant ssh -c "sudo /vagrant/script/env.sh $1"
    ;;
esac

